<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileSmile Architecture Documentation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #fff;
        }
        h1 {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        h2 {
            color: #333;
            margin-top: 40px;
            margin-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
        }
        h3 {
            color: #555;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        p {
            margin-bottom: 15px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f5f5f5;
            font-weight: 600;
        }
        tr:nth-child(even) {
            background: #fafafa;
        }
        .toc {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .toc ul {
            list-style: none;
            padding-left: 20px;
        }
        .toc a {
            color: #1a73e8;
            text-decoration: none;
        }
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', monospace;
            font-size: 13px;
        }
        pre {
            background: #2d2d2d;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 13px;
            margin: 15px 0;
        }
        .diagram {
            margin: 30px 0;
            text-align: center;
        }
        .diagram svg {
            max-width: 100%;
            height: auto;
        }
        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 10px 15px;
            margin: 15px 0;
        }
        .checklist {
            list-style: none;
            padding-left: 0;
        }
        .checklist li {
            padding: 5px 0;
            padding-left: 25px;
            position: relative;
        }
        .checklist li:before {
            content: "☐";
            position: absolute;
            left: 0;
        }
        @media print {
            body {
                padding: 20px;
            }
            h2 {
                page-break-before: always;
            }
            h2:first-of-type {
                page-break-before: avoid;
            }
            .diagram {
                page-break-inside: avoid;
            }
            table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>

<h1>FileSmile Architecture Documentation</h1>

<p>This document describes the FileSmile platform architecture for both development (Portainer) and production (Azure) environments.</p>

<div class="toc">
    <h3>Table of Contents</h3>
    <ul>
        <li>1. <a href="#overview">System Overview</a></li>
        <li>2. <a href="#dev">Development Environment (Portainer)</a></li>
        <li>3. <a href="#prod">Production Environment (Azure)</a></li>
        <li>4. <a href="#services">Services & Components</a></li>
        <li>5. <a href="#env">Environment Variables</a></li>
        <li>6. <a href="#deploy">Deployment Procedures</a></li>
        <li>7. <a href="#security">Security Considerations</a></li>
    </ul>
</div>

<h2 id="overview">1. System Overview</h2>

<p>FileSmile is a multi-tenant email-to-Priority ERP integration platform. It enables users to attach emails, email attachments, and scanned documents directly to Priority ERP documents.</p>

<h3>High-Level Architecture</h3>

<div class="diagram">
<svg viewBox="0 0 800 580" xmlns="http://www.w3.org/2000/svg">
    <!-- Client Applications Box -->
    <rect x="50" y="20" width="700" height="100" rx="10" fill="#e3f2fd" stroke="#1a73e8" stroke-width="2"/>
    <text x="400" y="45" text-anchor="middle" font-weight="bold" fill="#1a73e8">CLIENT APPLICATIONS</text>

    <!-- Client boxes -->
    <rect x="70" y="55" width="140" height="50" rx="5" fill="#fff" stroke="#666"/>
    <text x="140" y="78" text-anchor="middle" font-size="12" font-weight="bold">Outlook Add-in</text>
    <text x="140" y="93" text-anchor="middle" font-size="10" fill="#666">(Office.js)</text>

    <rect x="230" y="55" width="140" height="50" rx="5" fill="#fff" stroke="#666"/>
    <text x="300" y="78" text-anchor="middle" font-size="12" font-weight="bold">Gmail Add-on</text>
    <text x="300" y="93" text-anchor="middle" font-size="10" fill="#666">(Apps Script)</text>

    <rect x="390" y="55" width="140" height="50" rx="5" fill="#fff" stroke="#666"/>
    <text x="460" y="78" text-anchor="middle" font-size="12" font-weight="bold">Scanner App</text>
    <text x="460" y="93" text-anchor="middle" font-size="10" fill="#666">(Next.js)</text>

    <rect x="550" y="55" width="140" height="50" rx="5" fill="#fff" stroke="#666"/>
    <text x="620" y="78" text-anchor="middle" font-size="12" font-weight="bold">Admin Dashboard</text>
    <text x="620" y="93" text-anchor="middle" font-size="10" fill="#666">(Static HTML)</text>

    <!-- Arrow down -->
    <line x1="400" y1="120" x2="400" y2="155" stroke="#333" stroke-width="2"/>
    <polygon points="400,160 395,150 405,150" fill="#333"/>
    <text x="430" y="145" font-size="11" fill="#666">HTTPS</text>

    <!-- FileSmile Platform Box -->
    <rect x="50" y="165" width="700" height="260" rx="10" fill="#e8f5e9" stroke="#4caf50" stroke-width="2"/>
    <text x="400" y="188" text-anchor="middle" font-weight="bold" fill="#4caf50">FILESMILE PLATFORM</text>

    <!-- Traefik -->
    <rect x="300" y="200" width="200" height="50" rx="5" fill="#1a73e8"/>
    <text x="400" y="225" text-anchor="middle" fill="#fff" font-weight="bold">Traefik Reverse Proxy</text>
    <text x="400" y="242" text-anchor="middle" fill="#fff" font-size="11">:80 / :443</text>

    <!-- Arrows from Traefik -->
    <line x1="340" y1="250" x2="220" y2="295" stroke="#333" stroke-width="2"/>
    <polygon points="215,300 225,292 220,285" fill="#333"/>
    <text x="255" y="270" font-size="10" fill="#666">/api/*</text>

    <line x1="460" y1="250" x2="580" y2="295" stroke="#333" stroke-width="2"/>
    <polygon points="585,300 575,285 580,292" fill="#333"/>
    <text x="540" y="270" font-size="10" fill="#666">/scanner/*</text>

    <!-- FastAPI Backend -->
    <rect x="100" y="300" width="200" height="55" rx="5" fill="#4caf50"/>
    <text x="200" y="325" text-anchor="middle" fill="#fff" font-weight="bold">FastAPI Backend</text>
    <text x="200" y="343" text-anchor="middle" fill="#fff" font-size="11">:8002</text>

    <!-- Scanner App Server -->
    <rect x="500" y="300" width="200" height="55" rx="5" fill="#ff9800"/>
    <text x="600" y="325" text-anchor="middle" fill="#fff" font-weight="bold">Scanner App Server</text>
    <text x="600" y="343" text-anchor="middle" fill="#fff" font-size="11">:3001</text>

    <!-- Arrow from Scanner to API (dashed) -->
    <line x1="500" y1="328" x2="305" y2="328" stroke="#333" stroke-width="1.5" stroke-dasharray="5,5"/>
    <polygon points="300,328 310,323 310,333" fill="#333"/>
    <text x="400" y="318" text-anchor="middle" font-size="10" fill="#666">API calls</text>

    <!-- PostgreSQL -->
    <rect x="130" y="375" width="180" height="40" rx="5" fill="#9c27b0"/>
    <text x="220" y="400" text-anchor="middle" fill="#fff" font-weight="bold">PostgreSQL :5432</text>

    <!-- Arrow from API to DB -->
    <line x1="200" y1="355" x2="210" y2="370" stroke="#333" stroke-width="2"/>
    <polygon points="215,375 205,368 212,362" fill="#333"/>

    <!-- External Systems Box -->
    <rect x="250" y="470" width="300" height="70" rx="10" fill="#fce4ec" stroke="#e91e63" stroke-width="2"/>
    <text x="400" y="495" text-anchor="middle" font-weight="bold" fill="#e91e63">EXTERNAL SYSTEMS</text>
    <rect x="300" y="508" width="200" height="28" rx="5" fill="#fff" stroke="#666"/>
    <text x="400" y="527" text-anchor="middle" font-size="12">Priority ERP (OData API)</text>

    <!-- Arrow from API to ERP -->
    <line x1="220" y1="415" x2="220" y2="445" stroke="#333" stroke-width="2"/>
    <line x1="220" y1="445" x2="350" y2="445" stroke="#333" stroke-width="2"/>
    <line x1="350" y1="445" x2="350" y2="465" stroke="#333" stroke-width="2"/>
    <polygon points="350,470 345,460 355,460" fill="#333"/>
    <text x="290" y="438" font-size="10" fill="#666">OData</text>
</svg>
</div>

<h3>Component Descriptions</h3>

<table>
    <tr>
        <th>Component</th>
        <th>Technology</th>
        <th>Purpose</th>
    </tr>
    <tr>
        <td><strong>FastAPI Backend</strong></td>
        <td>Python 3.11, FastAPI, SQLAlchemy</td>
        <td>Core API server - handles authentication, document search, attachment uploads</td>
    </tr>
    <tr>
        <td><strong>Scanner App</strong></td>
        <td>Next.js 16, TypeScript, Zustand</td>
        <td>Web application for document scanning via TWAIN and barcode matching</td>
    </tr>
    <tr>
        <td><strong>Traefik</strong></td>
        <td>Traefik v3.0</td>
        <td>Reverse proxy with automatic SSL, routing, and load balancing</td>
    </tr>
    <tr>
        <td><strong>PostgreSQL</strong></td>
        <td>PostgreSQL 16</td>
        <td>Multi-tenant database for users, tenants, and encrypted credentials</td>
    </tr>
    <tr>
        <td><strong>Outlook Add-in</strong></td>
        <td>Office.js, vanilla JS</td>
        <td>Email attachment integration for Microsoft Outlook</td>
    </tr>
    <tr>
        <td><strong>Gmail Add-on</strong></td>
        <td>Google Apps Script</td>
        <td>Email attachment integration for Gmail</td>
    </tr>
</table>

<h2 id="dev">2. Development Environment (Portainer)</h2>

<h3>Architecture Diagram</h3>

<div class="diagram">
<svg viewBox="0 0 800 420" xmlns="http://www.w3.org/2000/svg">
    <!-- Developer -->
    <rect x="300" y="10" width="200" height="45" rx="8" fill="#e0e0e0" stroke="#666" stroke-width="2"/>
    <text x="400" y="38" text-anchor="middle" font-weight="bold" font-size="13">Developer Workstation</text>

    <!-- Arrow from Developer -->
    <line x1="400" y1="55" x2="400" y2="85" stroke="#333" stroke-width="2"/>
    <polygon points="400,90 395,82 405,82" fill="#333"/>
    <text x="510" y="75" font-size="10" fill="#666">http://filesmile.local</text>

    <!-- Portainer Stack Box -->
    <rect x="50" y="95" width="700" height="310" rx="10" fill="#f3e5f5" stroke="#9c27b0" stroke-width="2"/>
    <text x="400" y="118" text-anchor="middle" font-weight="bold" fill="#9c27b0" font-size="14">PORTAINER STACK: filesmile-dev</text>

    <!-- Docker Network Box -->
    <rect x="70" y="130" width="420" height="170" rx="8" fill="#e8eaf6" stroke="#3f51b5" stroke-width="2"/>
    <text x="280" y="152" text-anchor="middle" font-weight="bold" fill="#3f51b5">Docker Network: filesmile-net</text>

    <!-- Traefik -->
    <rect x="90" y="165" width="115" height="55" rx="5" fill="#1a73e8"/>
    <text x="147" y="188" text-anchor="middle" fill="#fff" font-weight="bold" font-size="12">traefik</text>
    <text x="147" y="205" text-anchor="middle" fill="#fff" font-size="10">:80 :443 :8080</text>

    <!-- filesmile-api -->
    <rect x="220" y="165" width="115" height="55" rx="5" fill="#4caf50"/>
    <text x="277" y="188" text-anchor="middle" fill="#fff" font-weight="bold" font-size="12">filesmile-api</text>
    <text x="277" y="205" text-anchor="middle" fill="#fff" font-size="10">:8002</text>

    <!-- scanner-app -->
    <rect x="350" y="165" width="115" height="55" rx="5" fill="#ff9800"/>
    <text x="407" y="188" text-anchor="middle" fill="#fff" font-weight="bold" font-size="12">scanner-app</text>
    <text x="407" y="205" text-anchor="middle" fill="#fff" font-size="10">:3001</text>

    <!-- postgres -->
    <rect x="220" y="240" width="115" height="45" rx="5" fill="#9c27b0"/>
    <text x="277" y="268" text-anchor="middle" fill="#fff" font-weight="bold" font-size="12">postgres :5432</text>

    <!-- Arrow from API to postgres -->
    <line x1="277" y1="220" x2="277" y2="240" stroke="#333" stroke-width="1.5"/>
    <polygon points="277,240 273,233 281,233" fill="#333"/>

    <!-- Volumes Box -->
    <rect x="520" y="130" width="210" height="170" rx="8" fill="#fff3e0" stroke="#ff9800" stroke-width="2"/>
    <text x="625" y="152" text-anchor="middle" font-weight="bold" fill="#ff9800">Volumes</text>

    <!-- Volume items -->
    <rect x="535" y="165" width="180" height="35" rx="5" fill="#fff" stroke="#666"/>
    <text x="625" y="188" text-anchor="middle" font-size="11">postgres-data</text>

    <rect x="535" y="210" width="180" height="35" rx="5" fill="#fff" stroke="#666"/>
    <text x="625" y="233" text-anchor="middle" font-size="11">traefik-certs</text>

    <rect x="535" y="255" width="180" height="35" rx="5" fill="#fff" stroke="#666"/>
    <text x="625" y="278" text-anchor="middle" font-size="11">filesmile-db</text>

    <!-- Dashed connection lines -->
    <line x1="490" y1="262" x2="535" y2="272" stroke="#999" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="490" y1="192" x2="535" y2="227" stroke="#999" stroke-width="1" stroke-dasharray="4,3"/>
    <line x1="335" y1="262" x2="535" y2="182" stroke="#999" stroke-width="1" stroke-dasharray="4,3"/>
</svg>
</div>

<h3>Stack Configuration</h3>

<table>
    <tr>
        <th>Service</th>
        <th>Container</th>
        <th>Exposed Ports</th>
        <th>Internal Port</th>
    </tr>
    <tr>
        <td>Traefik</td>
        <td>traefik</td>
        <td>80, 443, 8080 (dashboard)</td>
        <td>-</td>
    </tr>
    <tr>
        <td>FastAPI Backend</td>
        <td>filesmile-api</td>
        <td>-</td>
        <td>8002</td>
    </tr>
    <tr>
        <td>Scanner App</td>
        <td>scanner-app</td>
        <td>-</td>
        <td>3001</td>
    </tr>
    <tr>
        <td>PostgreSQL</td>
        <td>postgres</td>
        <td>5432 (optional)</td>
        <td>5432</td>
    </tr>
</table>

<h3>Volume Mounts</h3>

<table>
    <tr>
        <th>Volume</th>
        <th>Container</th>
        <th>Mount Path</th>
        <th>Purpose</th>
    </tr>
    <tr>
        <td><code>postgres-data</code></td>
        <td>postgres</td>
        <td>/var/lib/postgresql/data</td>
        <td>Database persistence</td>
    </tr>
    <tr>
        <td><code>traefik-certs</code></td>
        <td>traefik</td>
        <td>/letsencrypt</td>
        <td>SSL certificates</td>
    </tr>
    <tr>
        <td><code>filesmile-db</code></td>
        <td>filesmile-api</td>
        <td>/app/db</td>
        <td>SQLite fallback / seed data</td>
    </tr>
</table>

<h2 id="prod">3. Production Environment (Azure)</h2>

<h3>Architecture Diagram</h3>

<div class="diagram">
<svg viewBox="0 0 800 520" xmlns="http://www.w3.org/2000/svg">
    <!-- Users -->
    <rect x="325" y="10" width="150" height="40" rx="8" fill="#e0e0e0" stroke="#666" stroke-width="2"/>
    <text x="400" y="35" text-anchor="middle" font-weight="bold">Users / Clients</text>

    <!-- Arrow -->
    <line x1="400" y1="50" x2="400" y2="85" stroke="#333" stroke-width="2"/>
    <polygon points="400,90 395,80 405,80" fill="#333"/>
    <text x="520" y="75" font-size="10" fill="#666">HTTPS (*.yourdomain.com)</text>

    <!-- Azure Subscription Box -->
    <rect x="30" y="95" width="740" height="410" rx="10" fill="#e3f2fd" stroke="#0078d4" stroke-width="2"/>
    <text x="400" y="118" text-anchor="middle" font-weight="bold" fill="#0078d4">AZURE SUBSCRIPTION</text>

    <!-- Resource Group Box -->
    <rect x="50" y="130" width="700" height="360" rx="8" fill="#e8f5e9" stroke="#4caf50" stroke-width="2"/>
    <text x="400" y="152" text-anchor="middle" font-weight="bold" fill="#4caf50">Resource Group: rg-filesmile-prod</text>

    <!-- Container Apps Environment -->
    <rect x="150" y="165" width="500" height="110" rx="8" fill="#fff3e0" stroke="#ff9800" stroke-width="2"/>
    <text x="400" y="185" text-anchor="middle" font-weight="bold" fill="#ff9800">Container Apps Environment</text>

    <!-- Container Apps -->
    <rect x="170" y="200" width="130" height="55" rx="5" fill="#1a73e8"/>
    <text x="235" y="225" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">Traefik</text>
    <text x="235" y="242" text-anchor="middle" fill="#fff" font-size="9">Container App</text>

    <rect x="335" y="200" width="130" height="55" rx="5" fill="#4caf50"/>
    <text x="400" y="225" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">filesmile-api</text>
    <text x="400" y="242" text-anchor="middle" fill="#fff" font-size="9">Container App</text>

    <rect x="500" y="200" width="130" height="55" rx="5" fill="#ff9800"/>
    <text x="565" y="225" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">scanner-app</text>
    <text x="565" y="242" text-anchor="middle" fill="#fff" font-size="9">Container App</text>

    <!-- Arrows between containers -->
    <line x1="300" y1="227" x2="330" y2="227" stroke="#333" stroke-width="1.5"/>
    <polygon points="335,227 325,222 325,232" fill="#333"/>

    <line x1="465" y1="227" x2="495" y2="227" stroke="#333" stroke-width="1.5"/>
    <polygon points="500,227 490,222 490,232" fill="#333"/>

    <!-- Virtual Network -->
    <rect x="150" y="290" width="500" height="35" rx="5" fill="#e8eaf6" stroke="#3f51b5" stroke-width="2"/>
    <text x="400" y="312" text-anchor="middle" font-weight="bold" fill="#3f51b5">Virtual Network: vnet-filesmile</text>

    <!-- Azure Services -->
    <rect x="70" y="355" width="150" height="70" rx="5" fill="#0078d4"/>
    <text x="145" y="380" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">Azure Container</text>
    <text x="145" y="397" text-anchor="middle" fill="#fff" font-size="10">Registry</text>
    <text x="145" y="414" text-anchor="middle" fill="#fff" font-size="9">filesmilecr.azurecr.io</text>

    <rect x="245" y="355" width="150" height="70" rx="5" fill="#9c27b0"/>
    <text x="320" y="380" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">Azure Database</text>
    <text x="320" y="397" text-anchor="middle" fill="#fff" font-size="10">for PostgreSQL</text>
    <text x="320" y="414" text-anchor="middle" fill="#fff" font-size="9">psql-filesmile</text>

    <rect x="420" y="355" width="150" height="70" rx="5" fill="#0078d4"/>
    <text x="495" y="385" text-anchor="middle" fill="#fff" font-weight="bold" font-size="11">Azure Key Vault</text>
    <text x="495" y="405" text-anchor="middle" fill="#fff" font-size="10">kv-filesmile</text>

    <!-- Dashed lines from ACR to containers -->
    <line x1="145" y1="355" x2="235" y2="260" stroke="#999" stroke-width="1" stroke-dasharray="4,4"/>
    <line x1="160" y1="355" x2="400" y2="260" stroke="#999" stroke-width="1" stroke-dasharray="4,4"/>
    <line x1="190" y1="355" x2="565" y2="260" stroke="#999" stroke-width="1" stroke-dasharray="4,4"/>
    <text x="100" y="310" font-size="9" fill="#666">Pull images</text>

    <!-- Solid lines from API to DB and KV -->
    <line x1="380" y1="255" x2="320" y2="350" stroke="#333" stroke-width="1.5"/>
    <polygon points="320,355 315,345 325,345" fill="#333"/>

    <line x1="420" y1="255" x2="495" y2="350" stroke="#333" stroke-width="1.5"/>
    <polygon points="495,355 490,345 500,345" fill="#333"/>

    <!-- External Priority ERP -->
    <rect x="595" y="355" width="135" height="70" rx="5" fill="#fce4ec" stroke="#e91e63" stroke-width="2"/>
    <text x="662" y="385" text-anchor="middle" font-weight="bold" fill="#e91e63" font-size="11">Priority ERP</text>
    <text x="662" y="405" text-anchor="middle" font-size="10">(On-Premise/Cloud)</text>

    <!-- Arrow to ERP -->
    <line x1="400" y1="255" x2="400" y2="300" stroke="#333" stroke-width="1.5"/>
    <line x1="400" y1="300" x2="620" y2="300" stroke="#333" stroke-width="1.5"/>
    <line x1="620" y1="300" x2="620" y2="350" stroke="#333" stroke-width="1.5"/>
    <polygon points="620,355 615,345 625,345" fill="#333"/>
    <text x="520" y="293" font-size="9" fill="#666">OData API</text>
</svg>
</div>

<h3>Azure Resources</h3>

<table>
    <tr>
        <th>Resource</th>
        <th>Type</th>
        <th>SKU/Tier</th>
        <th>Purpose</th>
    </tr>
    <tr>
        <td><code>rg-filesmile-prod</code></td>
        <td>Resource Group</td>
        <td>-</td>
        <td>Container for all resources</td>
    </tr>
    <tr>
        <td><code>cae-filesmile</code></td>
        <td>Container Apps Environment</td>
        <td>Consumption</td>
        <td>Hosts all container apps</td>
    </tr>
    <tr>
        <td><code>ca-filesmile-api</code></td>
        <td>Container App</td>
        <td>Consumption</td>
        <td>FastAPI backend</td>
    </tr>
    <tr>
        <td><code>ca-scanner-app</code></td>
        <td>Container App</td>
        <td>Consumption</td>
        <td>Next.js scanner app</td>
    </tr>
    <tr>
        <td><code>filesmilecr</code></td>
        <td>Container Registry</td>
        <td>Basic</td>
        <td>Docker image storage</td>
    </tr>
    <tr>
        <td><code>psql-filesmile</code></td>
        <td>PostgreSQL Flexible Server</td>
        <td>Burstable B1ms</td>
        <td>Production database</td>
    </tr>
    <tr>
        <td><code>kv-filesmile</code></td>
        <td>Key Vault</td>
        <td>Standard</td>
        <td>Secrets management</td>
    </tr>
</table>

<div class="note">
    <strong>Note:</strong> Azure Container Apps has built-in ingress. Traefik is optional but provides consistent dev/prod parity.
</div>

<h3>Database Configuration</h3>

<table>
    <tr>
        <th>Setting</th>
        <th>Value</th>
    </tr>
    <tr><td>Version</td><td>PostgreSQL 16</td></tr>
    <tr><td>SKU</td><td>Burstable B1ms (1 vCore, 2GB RAM)</td></tr>
    <tr><td>Storage</td><td>32 GB</td></tr>
    <tr><td>Backup</td><td>Geo-redundant, 7 days retention</td></tr>
    <tr><td>Connection</td><td>SSL required</td></tr>
    <tr><td>Firewall</td><td>Allow Azure services + VNet</td></tr>
</table>

<h2 id="services">4. Services & Components</h2>

<h3>Service Matrix</h3>

<table>
    <tr>
        <th>Service</th>
        <th>Image</th>
        <th>Port</th>
        <th>Health Check</th>
        <th>Dependencies</th>
    </tr>
    <tr>
        <td><strong>filesmile-api</strong></td>
        <td><code>filesmilecr.azurecr.io/filesmile-api:latest</code></td>
        <td>8002</td>
        <td><code>GET /health</code></td>
        <td>PostgreSQL</td>
    </tr>
    <tr>
        <td><strong>scanner-app</strong></td>
        <td><code>filesmilecr.azurecr.io/scanner-app:latest</code></td>
        <td>3001</td>
        <td><code>GET /</code></td>
        <td>filesmile-api</td>
    </tr>
    <tr>
        <td><strong>traefik</strong></td>
        <td><code>traefik:v3.0</code></td>
        <td>80, 443, 8080</td>
        <td>Built-in</td>
        <td>-</td>
    </tr>
    <tr>
        <td><strong>postgres</strong></td>
        <td><code>postgres:16-alpine</code></td>
        <td>5432</td>
        <td><code>pg_isready</code></td>
        <td>-</td>
    </tr>
</table>

<h3>API Endpoints Structure</h3>

<pre>
https://api.yourdomain.com/
├── /api/v1/
│   ├── /auth/           # Authentication (JWT)
│   │   ├── POST /tenant/resolve
│   │   ├── POST /login
│   │   ├── POST /register
│   │   └── POST /switch-tenant
│   ├── /search/         # Document search
│   │   ├── GET  /companies
│   │   ├── GET  /groups
│   │   ├── POST /documents
│   │   └── GET  /form-prefixes
│   ├── /attachments/    # File operations
│   │   ├── POST /upload
│   │   ├── GET  /list
│   │   └── DELETE /{id}
│   └── /admin/          # Tenant management
├── /health              # Health check
├── /docs                # Swagger UI
└── /                    # Admin dashboard (static)
</pre>

<h2 id="env">5. Environment Variables</h2>

<h3>Backend (filesmile-api)</h3>

<table>
    <tr>
        <th>Variable</th>
        <th>Required</th>
        <th>Development</th>
        <th>Production</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>DATABASE_URL</code></td>
        <td>Yes</td>
        <td>postgresql://filesmile:password@postgres:5432/filesmile</td>
        <td>postgresql://...@psql-filesmile.postgres.database.azure.com</td>
        <td>Database connection string</td>
    </tr>
    <tr>
        <td><code>SECRET_KEY</code></td>
        <td>Yes</td>
        <td>Generate with <code>openssl rand -hex 32</code></td>
        <td>Azure Key Vault</td>
        <td>FastAPI session secret</td>
    </tr>
    <tr>
        <td><code>JWT_SECRET_KEY</code></td>
        <td>Yes</td>
        <td>Generate with <code>openssl rand -hex 32</code></td>
        <td>Azure Key Vault</td>
        <td>JWT signing key</td>
    </tr>
    <tr>
        <td><code>ENCRYPTION_KEY</code></td>
        <td>Yes</td>
        <td>Generate with <code>openssl rand -hex 32</code></td>
        <td>Azure Key Vault</td>
        <td>ERP credential encryption</td>
    </tr>
    <tr>
        <td><code>DEBUG</code></td>
        <td>No</td>
        <td>True</td>
        <td>False</td>
        <td>Debug mode</td>
    </tr>
    <tr>
        <td><code>ALLOWED_ORIGINS</code></td>
        <td>Yes</td>
        <td>*</td>
        <td>https://yourdomain.com</td>
        <td>CORS allowed origins</td>
    </tr>
</table>

<h3>Scanner App (scanner-app)</h3>

<table>
    <tr>
        <th>Variable</th>
        <th>Required</th>
        <th>Development</th>
        <th>Production</th>
        <th>Description</th>
    </tr>
    <tr>
        <td><code>NEXT_PUBLIC_API_URL</code></td>
        <td>Yes</td>
        <td>http://localhost:8002/api/v1</td>
        <td>https://api.yourdomain.com/api/v1</td>
        <td>Backend API URL</td>
    </tr>
    <tr>
        <td><code>NEXT_PUBLIC_VINTASOFT_*</code></td>
        <td>No</td>
        <td>VintaSoft license keys</td>
        <td>VintaSoft license keys</td>
        <td>Scanner SDK license</td>
    </tr>
</table>

<h2 id="deploy">6. Deployment Procedures</h2>

<h3>6.1 Development (Portainer)</h3>

<h4>Prerequisites</h4>
<ul>
    <li>Docker installed on server</li>
    <li>Portainer running</li>
    <li>Git repository access</li>
</ul>

<h4>Steps</h4>
<ol>
    <li><strong>Clone Repository</strong>
        <pre>git clone https://github.com/your-org/FileSmileJS.git
cd FileSmileJS</pre>
    </li>
    <li><strong>Build Images</strong>
        <pre># Build API image
docker build -t filesmile-api:latest -f Dockerfile .

# Build Scanner App image
docker build -t scanner-app:latest -f scanner-app/Dockerfile ./scanner-app</pre>
    </li>
    <li><strong>Deploy via Portainer</strong>
        <ul>
            <li>Go to Portainer → Stacks → Add Stack</li>
            <li>Upload <code>docker-compose.portainer.yml</code></li>
            <li>Set environment variables</li>
            <li>Deploy</li>
        </ul>
    </li>
    <li><strong>Verify Deployment</strong>
        <pre>curl http://localhost/health
curl http://localhost/api/v1/docs</pre>
    </li>
</ol>

<h3>6.2 Production (Azure)</h3>

<h4>Steps</h4>
<ol>
    <li><strong>Build and Push Images</strong>
        <pre># Login to Azure Container Registry
az acr login --name filesmilecr

# Build and push API
docker build -t filesmilecr.azurecr.io/filesmile-api:v1.0.0 -f Dockerfile .
docker push filesmilecr.azurecr.io/filesmile-api:v1.0.0

# Build and push Scanner App
docker build -t filesmilecr.azurecr.io/scanner-app:v1.0.0 -f scanner-app/Dockerfile ./scanner-app
docker push filesmilecr.azurecr.io/scanner-app:v1.0.0</pre>
    </li>
    <li><strong>Create Azure Resources</strong> (via Portal or CLI)
        <ul>
            <li>Resource Group</li>
            <li>Container Apps Environment</li>
            <li>PostgreSQL Flexible Server</li>
            <li>Key Vault with secrets</li>
        </ul>
    </li>
    <li><strong>Deploy Container Apps</strong>
        <pre>az containerapp create \
  --name ca-filesmile-api \
  --resource-group rg-filesmile-prod \
  --environment cae-filesmile \
  --image filesmilecr.azurecr.io/filesmile-api:v1.0.0 \
  --target-port 8002 \
  --ingress external</pre>
    </li>
    <li><strong>Configure Custom Domain</strong></li>
    <li><strong>Verify Deployment</strong></li>
</ol>

<h2 id="security">7. Security Considerations</h2>

<h3>Authentication Flow</h3>

<div class="diagram">
<svg viewBox="0 0 800 400" xmlns="http://www.w3.org/2000/svg">
    <!-- Participants -->
    <rect x="50" y="20" width="80" height="30" rx="5" fill="#e0e0e0" stroke="#666"/>
    <text x="90" y="40" text-anchor="middle" font-size="12" font-weight="bold">User</text>
    <line x1="90" y1="50" x2="90" y2="380" stroke="#666" stroke-width="1"/>

    <rect x="200" y="20" width="100" height="30" rx="5" fill="#e0e0e0" stroke="#666"/>
    <text x="250" y="40" text-anchor="middle" font-size="12" font-weight="bold">Client App</text>
    <line x1="250" y1="50" x2="250" y2="380" stroke="#666" stroke-width="1"/>

    <rect x="380" y="20" width="100" height="30" rx="5" fill="#4caf50" stroke="#666"/>
    <text x="430" y="40" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">API</text>
    <line x1="430" y1="50" x2="430" y2="380" stroke="#666" stroke-width="1"/>

    <rect x="550" y="20" width="100" height="30" rx="5" fill="#9c27b0" stroke="#666"/>
    <text x="600" y="40" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">PostgreSQL</text>
    <line x1="600" y1="50" x2="600" y2="380" stroke="#666" stroke-width="1"/>

    <rect x="700" y="20" width="80" height="30" rx="5" fill="#e91e63" stroke="#666"/>
    <text x="740" y="40" text-anchor="middle" font-size="12" font-weight="bold" fill="#fff">ERP</text>
    <line x1="740" y1="50" x2="740" y2="380" stroke="#666" stroke-width="1"/>

    <!-- Step 1: Enter email -->
    <path d="M90 80 L250 80" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="170" y="75" text-anchor="middle" font-size="10">1. Enter email</text>

    <!-- Step 2: Resolve tenant -->
    <path d="M250 100 L430 100" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="340" y="95" text-anchor="middle" font-size="10">2. POST /auth/tenant/resolve</text>

    <!-- Step 3: Lookup -->
    <path d="M430 120 L600 120" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="515" y="115" text-anchor="middle" font-size="10">3. Lookup tenant</text>

    <path d="M600 140 L430 140" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="515" y="155" text-anchor="middle" font-size="10">Tenant info</text>

    <!-- Step 4: Return options -->
    <path d="M430 160 L250 160" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="340" y="175" text-anchor="middle" font-size="10">4. Tenant options</text>

    <!-- Step 5: Enter credentials -->
    <path d="M90 200 L250 200" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="170" y="195" text-anchor="middle" font-size="10">5. Enter ERP credentials</text>

    <!-- Step 6: Register -->
    <path d="M250 220 L430 220" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="340" y="215" text-anchor="middle" font-size="10">6. POST /auth/register</text>

    <!-- Step 7: Validate with ERP -->
    <path d="M430 240 L740 240" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="585" y="235" text-anchor="middle" font-size="10">7. Validate credentials</text>

    <path d="M740 260 L430 260" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="585" y="275" text-anchor="middle" font-size="10">Success</text>

    <!-- Step 8: Store encrypted -->
    <path d="M430 280 L600 280" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="515" y="295" text-anchor="middle" font-size="10">8. Store encrypted creds</text>

    <!-- Step 9: Return JWT -->
    <path d="M430 310 L250 310" stroke="#333" stroke-width="1.5" marker-end="url(#arrowhead)"/>
    <text x="340" y="325" text-anchor="middle" font-size="10">9. JWT token</text>

    <!-- Step 10: Use API -->
    <rect x="200" y="340" width="250" height="25" rx="3" fill="#fff3cd" stroke="#ffc107"/>
    <text x="325" y="357" text-anchor="middle" font-size="10">10. Subsequent requests use Bearer JWT</text>
</svg>
</div>

<h3>Security Checklist</h3>

<ul class="checklist">
    <li>All secrets stored in Azure Key Vault (production)</li>
    <li>PostgreSQL SSL connection required</li>
    <li>CORS restricted to known origins</li>
    <li>JWT tokens expire after 24 hours</li>
    <li>ERP credentials encrypted with Fernet (AES-128)</li>
    <li>Non-root container users</li>
    <li>Network isolation via VNet</li>
    <li>HTTPS enforced (redirect HTTP → HTTPS)</li>
    <li>Container vulnerability scanning enabled</li>
</ul>

<h3>Backup & Recovery</h3>

<table>
    <tr>
        <th>Component</th>
        <th>Backup Method</th>
        <th>Retention</th>
        <th>RTO</th>
    </tr>
    <tr>
        <td>PostgreSQL</td>
        <td>Azure automated backup</td>
        <td>7 days</td>
        <td>1 hour</td>
    </tr>
    <tr>
        <td>Encryption keys</td>
        <td>Key Vault soft-delete</td>
        <td>90 days</td>
        <td>N/A</td>
    </tr>
    <tr>
        <td>Container images</td>
        <td>ACR geo-replication</td>
        <td>-</td>
        <td>Minutes</td>
    </tr>
</table>

<hr style="margin-top: 40px;">

<h2>Appendix: File Reference</h2>

<table>
    <tr>
        <th>File</th>
        <th>Purpose</th>
    </tr>
    <tr><td><code>Dockerfile</code></td><td>Root Dockerfile for API</td></tr>
    <tr><td><code>scanner-app/Dockerfile</code></td><td>Dockerfile for Scanner App</td></tr>
    <tr><td><code>docker-compose.yml</code></td><td>Development compose (local)</td></tr>
    <tr><td><code>docker-compose.portainer.yml</code></td><td>Portainer-ready full stack</td></tr>
    <tr><td><code>.env.example</code></td><td>Environment template</td></tr>
    <tr><td><code>entrypoint.sh</code></td><td>API container entrypoint</td></tr>
</table>

</body>
</html>
